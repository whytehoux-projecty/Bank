<%- include('layout', { body: ` <div x-data="portalStatus()">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
        <div>
            <!-- Title is handled by layout -->
            <p class="text-gray-500 mt-1">Control system availability and schedule maintenance windows.</p>
        </div>
        <div class="flex gap-2">
            <button @click="loadHistory()" class="btn btn-ghost text-gray-500 hover:text-navy-900"
                title="Refresh History">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Alert Banner -->
    <div x-show="alert.visible" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 -translate-y-2" class="mb-6 rounded-lg p-4 flex items-start" :class="{
            'bg-emerald-50 text-emerald-800 border-l-4 border-emerald-500': alert.type === 'success',
            'bg-red-50 text-red-800 border-l-4 border-red-500': alert.type === 'error'
         }">
        <div class="flex-shrink-0 mr-3">
            <svg x-show="alert.type === 'success'" class="h-5 w-5 text-emerald-500" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <svg x-show="alert.type === 'error'" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        </div>
        <div>
            <h3 class="text-sm font-medium" x-text="alert.message"></h3>
        </div>
        <button @click="alert.visible = false" class="ml-auto pl-3">
            <svg class="h-5 w-5 opacity-50 hover:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Left Column: Current Status & Controls -->
        <div class="space-y-8">
            <!-- Current Status Card -->
            <div class="card p-8">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-6">Current System Status</h3>

                <div class="flex flex-col items-center justify-center py-6">
                    <!-- Status Indicator Ring -->
                    <div class="relative mb-6">
                        <div class="h-32 w-32 rounded-full border-4 flex items-center justify-center shadow-lg" :class="{
                                 'border-emerald-500 bg-emerald-50': status.status === 'online',
                                 'border-red-500 bg-red-50': status.status === 'offline',
                                 'border-amber-500 bg-amber-50': status.status === 'maintenance',
                                 'border-blue-500 bg-blue-50': status.status === 'scheduled_downtime'
                             }">
                            <svg x-show="status.status === 'online'" class="w-16 h-16 text-emerald-600" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                            <svg x-show="status.status === 'offline'" class="w-16 h-16 text-red-600" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636">
                                </path>
                            </svg>
                            <svg x-show="status.status === 'maintenance'" class="w-16 h-16 text-amber-600" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <svg x-show="status.status === 'scheduled_downtime'" class="w-16 h-16 text-blue-600"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="absolute top-0 right-0 -mr-2 -mt-2">
                            <span class="relative flex h-4 w-4">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75"
                                    :class="{
                                          'bg-emerald-400': status.status === 'online',
                                          'bg-red-400': status.status === 'offline',
                                          'bg-amber-400': status.status === 'maintenance',
                                          'bg-blue-400': status.status === 'scheduled_downtime'
                                      }"></span>
                                <span class="relative inline-flex rounded-full h-4 w-4" :class="{
                                          'bg-emerald-500': status.status === 'online',
                                          'bg-red-500': status.status === 'offline',
                                          'bg-amber-500': status.status === 'maintenance',
                                          'bg-blue-500': status.status === 'scheduled_downtime'
                                      }"></span>
                            </span>
                        </div>
                    </div>

                    <h2 class="text-3xl font-display font-bold text-navy-900 mb-2 uppercase tracking-wide"
                        x-text="status.status.replace('_', ' ')"></h2>

                    <!-- Message Display -->
                    <div x-show="status.message"
                        class="bg-gray-50 border border-gray-200 rounded px-4 py-2 mt-2 max-w-sm text-center">
                        <p class="text-sm text-gray-600 italic">" <span x-text="status.message"></span> "</p>
                    </div>

                    <!-- Meta Info -->
                    <div class="mt-6 flex items-center space-x-6 text-sm text-gray-500">
                        <div class="flex flex-col items-center">
                            <span class="text-xs uppercase font-bold text-gray-400">Last Updated</span>
                            <span class="font-mono text-navy-900"
                                x-text="new Date(status.updatedAt).toLocaleString()"></span>
                        </div>
                        <div class="h-8 w-px bg-gray-200"></div>
                        <div class="flex flex-col items-center">
                            <span class="text-xs uppercase font-bold text-gray-400">Updated By</span>
                            <span class="font-medium text-navy-900" x-text="status.updatedBy?.name || 'System'"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card p-6">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Quick Actions</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button @click="updateStatus('online')"
                        class="btn flex flex-col items-center justify-center p-4 border border-emerald-200 bg-emerald-50 hover:bg-emerald-100 text-emerald-800 transition-all"
                        :disabled="loading || status.status === 'online'">
                        <svg class="h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        <span class="font-bold text-sm">Set Online</span>
                    </button>

                    <button @click="updateStatus('offline')"
                        class="btn flex flex-col items-center justify-center p-4 border border-red-200 bg-red-50 hover:bg-red-100 text-red-800 transition-all"
                        :disabled="loading || status.status === 'offline'">
                        <svg class="h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636">
                            </path>
                        </svg>
                        <span class="font-bold text-sm">Force Offline</span>
                    </button>

                    <button @click="modals.maintenance = true"
                        class="btn flex flex-col items-center justify-center p-4 border border-amber-200 bg-amber-50 hover:bg-amber-100 text-amber-800 transition-all">
                        <svg class="h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                        </svg>
                        <span class="font-bold text-sm">Maintenance Mode</span>
                    </button>

                    <button @click="modals.schedule = true"
                        class="btn flex flex-col items-center justify-center p-4 border border-blue-200 bg-blue-50 hover:bg-blue-100 text-blue-800 transition-all">
                        <svg class="h-6 w-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-bold text-sm">Schedule Maintenance</span>
                    </button>
                </div>
            </div>

            <!-- Scheduled Maintenance Info -->
            <div class="card p-6 border-l-4 border-blue-500 bg-blue-50" x-show="status.nextScheduledMaintenance">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <h3 class="text-sm font-bold text-blue-900">Upcoming Scheduled Maintenance</h3>
                        <p class="mt-1 text-sm text-blue-700">
                            Scheduled for <span class="font-bold"
                                x-text="new Date(status.nextScheduledMaintenance).toLocaleString()"></span>
                        </p>
                        <p class="mt-2 text-xs text-blue-600 italic"
                            x-text="status.scheduledMaintenanceMessage || 'No details provided'"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: History -->
        <div class="card flex flex-col h-full lg:min-h-[600px]">
            <div class="card-header border-b border-gray-100 py-4 px-6 flex justify-between items-center">
                <h3 class="text-base font-bold text-navy-900">Status History</h3>
            </div>
            <div class="flex-1 overflow-y-auto p-0 z-0">
                <table class="table w-full">
                    <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider text-left">
                                Time</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider text-left">
                                Status</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider text-left">By
                            </th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase tracking-wider text-left">
                                Reason</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <template x-for="entry in history" :key="entry.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 font-mono"
                                    x-text="new Date(entry.changedAt).toLocaleString()"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span
                                        class="inline-flex px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider"
                                        :class="{
                                              'bg-emerald-100 text-emerald-800': entry.newStatus === 'online',
                                              'bg-red-100 text-red-800': entry.newStatus === 'offline',
                                              'bg-amber-100 text-amber-800': entry.newStatus === 'maintenance',
                                              'bg-blue-100 text-blue-800': entry.newStatus === 'scheduled_downtime'
                                          }" x-text="entry.newStatus.replace('_', ' ')">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-navy-900"
                                    x-text="entry.changedBy?.name || 'System'"></td>
                                <td class="px-6 py-4 text-xs text-gray-500 max-w-xs truncate"
                                    x-text="entry.reason || '-'" :title="entry.reason"></td>
                            </tr>
                        </template>
                        <template x-if="history.length === 0">
                            <tr>
                                <td colspan="4" class="px-6 py-12 text-center text-gray-400">
                                    No history available
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Maintenance Modal -->
    <div x-show="modals.maintenance" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-content max-w-md" @click.away="modals.maintenance = false">
                <div class="modal-header bg-amber-500 text-white flex justify-between items-center rounded-t-xl">
                    <h3 class="font-bold flex items-center">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                        Enable Maintenance Mode
                    </h3>
                    <button @click="modals.maintenance = false" class="text-amber-100 hover:text-white"><svg
                            class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg></button>
                </div>
                <div class="modal-body space-y-4">
                    <div class="bg-amber-50 p-3 rounded text-amber-800 text-sm">
                        Users will be unable to access the portal. Admins will still have access.
                    </div>
                    <div>
                        <label class="form-label">Message to Users (Public)</label>
                        <textarea x-model="formData.message" rows="2" class="form-input"
                            placeholder="We are undergoing maintenance..."></textarea>
                    </div>
                    <div>
                        <label class="form-label">Internal Reason (Audit Log)</label>
                        <input x-model="formData.reason" type="text" class="form-input"
                            placeholder="Database Migration">
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="modals.maintenance = false" class="btn btn-ghost">Cancel</button>
                    <button @click="submitMaintenance()" class="btn btn-warning">Enable Maintenance</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div x-show="modals.schedule" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-content max-w-md" @click.away="modals.schedule = false">
                <div class="modal-header bg-blue-500 text-white flex justify-between items-center rounded-t-xl">
                    <h3 class="font-bold flex items-center">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Schedule Downtime
                    </h3>
                    <button @click="modals.schedule = false" class="text-blue-100 hover:text-white"><svg class="h-6 w-6"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg></button>
                </div>
                <div class="modal-body space-y-4">
                    <div>
                        <label class="form-label">Date & Time</label>
                        <input x-model="formData.scheduleDate" type="datetime-local" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Public Message</label>
                        <textarea x-model="formData.message" rows="2" class="form-input"
                            placeholder="Scheduled maintenance will begin..."></textarea>
                    </div>
                    <div>
                        <label class="form-label">Internal Reason</label>
                        <input x-model="formData.reason" type="text" class="form-input"
                            placeholder="Quarterly Security Patch">
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="modals.schedule = false" class="btn btn-ghost">Cancel</button>
                    <button @click="submitSchedule()" class="btn btn-primary">Schedule Event</button>
                </div>
            </div>
        </div>
    </div>

    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('portalStatus', () => ({
                loading: false,
                status: {
                    status: 'online',
                    message: '',
                    updatedAt: new Date(),
                    updatedBy: null,
                    nextScheduledMaintenance: null,
                    scheduledMaintenanceMessage: ''
                },
                history: [],
                formData: {
                    message: '',
                    reason: '',
                    scheduleDate: ''
                },
                modals: {
                    maintenance: false,
                    schedule: false
                },
                alert: {
                    visible: false,
                    type: 'success',
                    message: ''
                },

                init() {
                    this.loadStatus();
                    this.loadHistory();
                    setInterval(() => this.loadStatus(), 30000); // Polling
                },

                async loadStatus() {
                    try {
                        const res = await fetch('/api/portal/status');
                        const data = await res.json();
                        if (data.data) {
                            this.status = data.data;
                        }
                    } catch (e) {
                        console.error('Failed to load status', e);
                    }
                },

                async loadHistory() {
                    try {
                        const res = await fetch('/api/portal/status/history');
                        const data = await res.json();
                        if (data.data) {
                            this.history = data.data;
                        }
                    } catch (e) {
                        console.error('Failed to load history', e);
                    }
                },

                async updateStatus(newStatus, extraData = {}) {
                    if (newStatus !== 'online' && !confirm('Are you sure you want to change system status? This may affect all users.')) return;

                    this.loading = true;
                    try {
                        const res = await fetch('/api/portal/status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: newStatus, ...extraData })
                        });

                        if (res.ok) {
                            this.showAlert('success', 'Status Updated successfully');
                            await this.loadStatus();
                            await this.loadHistory();
                        } else {
                            throw new Error('Failed to update');
                        }
                    } catch (e) {
                        this.showAlert('error', 'Update Failed');
                    } finally {
                        this.loading = false;
                    }
                },

                async submitMaintenance() {
                    if (!this.formData.message || !this.formData.reason) {
                        alert('Please fill in all fields');
                        return;
                    }

                    await this.updateStatus('maintenance', {
                        message: this.formData.message,
                        reason: this.formData.reason
                    });

                    this.modals.maintenance = false;
                    this.resetForm();
                },

                async submitSchedule() {
                    if (!this.formData.scheduleDate || !this.formData.message) {
                        alert('Please fill in required fields');
                        return;
                    }

                    // The API expects 'scheduled_downtime' status to register a future downtime? 
                    // Or maybe just storing it. The original code used 'scheduled_downtime' status update.
                    // It sent nextScheduledMaintenance in the body.

                    await this.updateStatus('scheduled_downtime', {
                        nextScheduledMaintenance: new Date(this.formData.scheduleDate).toISOString(),
                        scheduledMaintenanceMessage: this.formData.message,
                        message: `Maintenance scheduled for ${new Date(this.formData.scheduleDate).toLocaleString()}`,
                    reason: this.formData.reason || 'Scheduled Maintenance'
                });
                
                this.modals.schedule = false;
                this.resetForm();
            },

            resetForm() {
                this.formData = { message: '', reason: '', scheduleDate: '' };
            },

            showAlert(type, msg) {
                this.alert.type = type;
                this.alert.message = msg;
                this.alert.visible = true;
                setTimeout(() => this.alert.visible = false, 5000);
            }
        }));
    });
    </script>
    ` }) %>