# Codebase Analysis Report: Staff Portal & E-Bank Portal

### Date: 2026-01-21

### Target: Invoice-Based Loan Repayment Implementation

## 1. Executive Summary

This report analyzes the existing codebases of **AurumVault** (E-Banking) and **UHI Staff Portal** to prepare for the implementation of an invoice-based loan repayment feature.

The **UHI Staff Portal** currently handles loan applications and has a rudimentary "Invoice Generation" feature that outputs payment details (Bank details, PIN, Invoice #). The **AurumVault E-Banking Portal** handles customer accounts and bill payments but has no current knowledge of Staff Portal loans.

The proposed feature requires robust integration where AurumVault can validate and process payments for invoices generated by the Staff Portal.

---

## 2. Relevant Files & Components

### A. UHI Staff Portal (Loan Management)

* **Path**: `@[UHI Staff Portal /backend/src/modules/finance/]`
* **Key Files**:
  * `loan.service.ts`: Core logic for loan lifecycle (Apply, Approve, Reject, Payment Recording). **Contains existing `generatePaymentInvoice` method.**
  * `loan.controller.ts`: API endpoints for loan operations.
  * `staff-portal/admin/loan-management.html`: Admin frontend for managing loans.
* **Key Features**:
  * `generatePaymentInvoice(userId, loanId, amount)`: Generates an ephemeral invoice with a `paymentPin` and `invoiceNumber`.
  * `recordPayment`: Internal method to deduct balance.

### B. AurumVault (E-Banking & Bill Payment)

* **Path**: `@[AURUMVAULT/backend/core-api/src/routes/]` & `@[AURUMVAULT/e-banking-portal/]`
* **Key Files**:
  * `bills.ts` (Backend): Handles payee management and `payBill` logic.
  * `app/bills/page.tsx` (Frontend): UI for making payments.
  * `prisma/schema.prisma`: Database definition.
* **Key Features**:
  * `payBill`: Deducts funds from `Account` and creates a `Transaction`.
  * `BillPayee`: Stores saved billers (Utilities, etc.).

---

## 3. Current Architecture

### A. Database Schemas

#### AurumVault (PostgreSQL - Prisma)

The schema is robust and centered around Banking.

* **User**: `id`, `email`, `accounts`, `kycStatus`.
* **Account**: `id`, `balance`, `transactions`.
* **Transaction**: `id`, `amount`, `type` (contains 'PAYMENT'), `reference`.
* **BillPayee**: `id`, `userId`, `accountNumber` (Target account for bills), `category`.

#### UHI Staff Portal (PostgreSQL - Prisma)

*Schema inferred from `loan.service.ts`*

* **User**: `id`, `staff_id`, `email`, `first_name`.
* **Loan**:
  * `id`, `user_id`
  * `amount`, `balance`
  * `status` (pending, approved, active, paid_off, rejected)
  * `interest_rate`, `monthly_payment`
  * `due_date`
* **LoanPayment**: `loan_id`, `amount`, `payment_reference`, `payment_method`.

### B. API Endpoints

#### AurumVault

* `GET /bills/payees`: List saved payees.
* `POST /bills/payees`: Add new payee.
* `POST /bills/pay`: Execute payment transaction.

#### UHI Staff Portal

* `POST /loans/apply`: Submit application.
* `POST /loans/:id/invoice`: **Generate Invoice JSON**.
* `POST /loans/:id/payment`: Record offline payment.
* `GET /admin/loans`: Loan management list.

---

## 4. Implementation Patterns & Conventions

* **Backend Structure**:
  * **AurumVault**: Uses `Fastify` with route-based architecture (`src/routes`). Uses `zod` for validation.
  * **UHI**: Uses a modular service-controller pattern (`src/modules/finance`). Uses class-based Services.
* **Database Access**: Both use `Prisma ORM`.
* **Frontend**:
  * **AurumVault**: Modern `Next.js` (React) with Tailwind CSS. Components are distinct files.
  * **UHI**: Static `HTML` with embedded/external Vanilla JS (`api.js`, `auth.js`) and CSS (`styles.css`).

---

## 5. Potential Conflicts & Integration Issues

### 1. Data Isolation

* **Issue**: The two systems likely use separate databases or at least separate schemas without direct access to each other.
* **Conflict**: AurumVault cannot query the `Loan` table to verify an Invoice ID or Payment PIN generated by UHI.

### 2. Invoice Persistence

* **Issue**: The `generatePaymentInvoice` method in `loan.service.ts` returns data *on-the-fly* but does not seem to save an "Invoice" record in the DB with a status (e.g., `PENDING_PAYMENT`).
* **Risk**: If a user generates an invoice and pays it, there's no persistent record to match the payment against until the payment is recorded.

### 3. Payment Verification

* **Issue**: Currently, UHI `recordPayment` expects an admin to manually record it or an offline hook.
* **Requirement**: AurumVault needs a secure channel (API Key / Shared Secret) to call `UHI Staff Portal` backend to:
    1. Validate Invoice details before payment.
    2. Confirm payment success and update Loan balance.

### 4. User Identity Mismatch

* **Issue**: A user might have a `Staff ID` in UHI and a different `User ID` in AurumVault.
* **Mitigation**: The Invoice must carry a unique reference that bridges this gap, or the user must link their Staff Account to their E-Banking Account.

---

## 6. Recommendations for Implementation

1. **Shared/Bridge API**: Create a secure endpoint in **UHI Backend** (`POST /api/inter-bank/validate-invoice` and `POST /api/inter-bank/confirm-payment`) that **AurumVault** can call.
2. **Persistent Invoices**: Modify `LoanService` to save generated invoices to a new `LoanInvoice` table so they can be validated.
3. **Frontend Update**:
    * In **UHI**: "Pay with AurumVault" button that redirects to the bank with invoice params.
    * In **AurumVault**: "Pay Loan/Invoice" section that accepts the Invoice # and PIN.
