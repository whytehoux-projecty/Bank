<%- include('partials/header', { title: 'System Configuration' , pagePath: '/settings' }) %>

    <div x-data="systemSettings()">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div>
                <!-- Title via layout -->
            </div>
            <div class="flex gap-2">
                <button @click="resetForm()" class="btn btn-ghost text-gray-500" :disabled="loading">
                    Discard Changes
                </button>
                <button @click="saveSettings()" class="btn btn-primary min-w-[160px]" :disabled="loading">
                    <span x-show="loading" class="spinner w-4 h-4 mr-2 border-white"></span>
                    <span x-show="!loading">Save Configuration</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Settings Form -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Verification Config Card -->
                <div class="card p-6">
                    <h3 class="text-lg font-display font-semibold text-navy-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Verification Configuration
                    </h3>

                    <!-- Toggle Switch -->
                    <div
                        class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200 mb-6">
                        <div>
                            <span class="block text-sm font-semibold text-navy-900">Enable Payment Verification</span>
                            <span class="block text-xs text-gray-500 mt-1">Requires admin approval for high-value
                                transactions</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="config.verificationEnabled" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-gold-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-gold-500">
                            </div>
                        </label>
                    </div>

                    <div class="mb-6">
                        <label class="form-label">Global Threshold Amount</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">$</span>
                            </div>
                            <input type="number" min="0" x-model.number="config.globalThreshold"
                                class="form-input pl-7">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Transactions above this amount trigger verification.</p>
                    </div>

                    <div class="h-px bg-gray-200 my-6"></div>

                    <!-- Category Thresholds -->
                    <h4 class="text-sm font-semibold text-navy-900 mb-4 uppercase tracking-wide">Category-Specific
                        Thresholds</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Utilities</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500">$</span>
                                </div>
                                <input type="number" min="0" x-model.number="config.categoryThresholds.UTILITIES"
                                    class="form-input pl-7">
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Internet/TV</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500">$</span>
                                </div>
                                <input type="number" min="0" x-model.number="config.categoryThresholds.INTERNET"
                                    class="form-input pl-7">
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Insurance</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500">$</span>
                                </div>
                                <input type="number" min="0" x-model.number="config.categoryThresholds.INSURANCE"
                                    class="form-input pl-7">
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Other</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500">$</span>
                                </div>
                                <input type="number" min="0" x-model.number="config.categoryThresholds.OTHER"
                                    class="form-input pl-7">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Types Card -->
                <div class="card p-6">
                    <h3 class="text-lg font-display font-semibold text-navy-900 mb-4">Accepted Document Types</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <label
                            class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" value="PASSPORT" x-model="config.documentTypes"
                                class="form-checkbox h-5 w-5">
                            <span class="text-sm text-gray-700">National Passport</span>
                        </label>
                        <label
                            class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" value="ID_CARD" x-model="config.documentTypes"
                                class="form-checkbox h-5 w-5">
                            <span class="text-sm text-gray-700">National ID Card</span>
                        </label>
                        <label
                            class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" value="DRIVERS_LICENSE" x-model="config.documentTypes"
                                class="form-checkbox h-5 w-5">
                            <span class="text-sm text-gray-700">Driver's License</span>
                        </label>
                        <label
                            class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" value="UTILITY_BILL" x-model="config.documentTypes"
                                class="form-checkbox h-5 w-5">
                            <span class="text-sm text-gray-700">Utility Bill</span>
                        </label>
                        <label
                            class="flex items-center space-x-3 cursor-pointer p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors">
                            <input type="checkbox" value="BANK_STATEMENT" x-model="config.documentTypes"
                                class="form-checkbox h-5 w-5">
                            <span class="text-sm text-gray-700">Bank Statement</span>
                        </label>
                    </div>
                </div>

                <!-- Notifications Card -->
                <div class="card p-6">
                    <h3 class="text-lg font-display font-semibold text-navy-900 mb-4">Admin Notifications</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Alert Email</label>
                            <input type="email" x-model="config.notificationEmail" class="form-input"
                                placeholder="admin@example.com">
                        </div>
                        <div>
                            <label class="form-label">Alert SMS</label>
                            <input type="text" x-model="config.notificationSms" class="form-input"
                                placeholder="+1234567890">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar: Simulator & History -->
            <div class="space-y-6">
                <!-- Policy Simulator -->
                <div class="card p-6 bg-navy-900 text-white border-navy-800">
                    <h3 class="text-lg font-display font-semibold text-white mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                            </path>
                        </svg>
                        Policy Simulator
                    </h3>
                    <p class="text-sm text-gray-300 mb-4">Test how current (unsaved) settings affect transactions.</p>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Transaction Amount ($)</label>
                            <input type="number" x-model.number="simulator.amount"
                                class="w-full px-3 py-2 bg-navy-800 border border-navy-700 rounded text-white focus:border-gold-500 focus:outline-none placeholder-gray-500">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Category</label>
                            <select x-model="simulator.category"
                                class="w-full px-3 py-2 bg-navy-800 border border-navy-700 rounded text-white focus:border-gold-500 focus:outline-none">
                                <option value="UTILITIES">Utilities</option>
                                <option value="INTERNET">Internet/TV</option>
                                <option value="INSURANCE">Insurance</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <button @click="runSimulation()"
                            class="btn w-full bg-gold-500 text-navy-900 hover:bg-gold-600 font-bold border-none">
                            Run Simulation
                        </button>
                    </div>

                    <!-- Simulation Result -->
                    <div x-show="simulator.result" x-transition class="mt-4 p-3 rounded-lg border"
                        :class="simulator.required ? 'bg-amber-500/10 border-amber-500/50 text-amber-200' : 'bg-emerald-500/10 border-emerald-500/50 text-emerald-200'">
                        <div class="flex items-start">
                            <div x-show="simulator.required">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                    </path>
                                </svg>
                            </div>
                            <div x-show="!simulator.required">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <strong class="block text-sm"
                                    x-text="simulator.required ? 'Verification Required' : 'Auto-Processed'"></strong>
                                <p class="text-xs opacity-80 mt-1" x-text="simulator.reason"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History -->
                <div class="card h-[400px] flex flex-col">
                    <div class="card-header flex items-center">
                        <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3 class="text-sm font-bold text-navy-900 uppercase tracking-wide">Configuration History</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 scrollbar-thin space-y-4">
                        <template x-if="history.loading">
                            <div class="text-center text-gray-400 py-4">Loading...</div>
                        </template>
                        <template x-if="!history.loading && history.data.length === 0">
                            <div class="text-center text-gray-400 py-4">No history available</div>
                        </template>
                        <template x-for="log in history.data" :key="log.id">
                            <div class="border-b border-gray-100 pb-3 last:border-0 last:pb-0">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-xs font-semibold text-navy-900 truncate max-w-[140px]"
                                        x-text="formatKey(log.entityId)"></span>
                                    <span class="text-[10px] text-gray-400"
                                        x-text="new Date(log.createdAt).toLocaleDateString()"></span>
                                </div>
                                <p class="text-xs text-gray-500 mb-1" x-text="'By Admin ' + log.adminUser.firstName">
                                </p>
                                <div class="text-xs flex items-center space-x-2">
                                    <span class="text-ruby-600 line-through opacity-70"
                                        x-text="JSON.parse(log.details || '{}').prev || 'none'"></span>
                                    <svg class="w-3 h-3 text-gray-300" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                    </svg>
                                    <span class="text-emerald-600 font-medium"
                                        x-text="JSON.parse(log.details || '{}').new"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div x-show="toast.visible" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
        x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
        x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed bottom-4 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden">
        <div class="p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg x-show="toast.type === 'success'" class="h-6 w-6 text-green-400" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <svg x-show="toast.type === 'error'" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="ml-3 w-0 flex-1 pt-0.5">
                    <p class="text-sm font-medium text-gray-900" x-text="toast.title"></p>
                    <p class="mt-1 text-sm text-gray-500" x-text="toast.message"></p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button @click="toast.visible = false"
                        class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500">
                        <span class="sr-only">Close</span>
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('systemSettings', () => ({
                loading: false,
                config: {
                    verificationEnabled: false,
                    globalThreshold: 0,
                    notificationEmail: '',
                    notificationSms: '',
                    categoryThresholds: { UTILITIES: 0, INTERNET: 0, INSURANCE: 0, OTHER: 0 },
                    documentTypes: []
                },
                simulator: {
                    amount: 0,
                    category: 'UTILITIES',
                    result: false,
                    required: false,
                    reason: ''
                },
                history: {
                    loading: true,
                    data: []
                },
                toast: {
                    visible: false,
                    type: 'success',
                    title: '',
                    message: ''
                },

                init() {
                    this.loadSettings();
                    this.loadHistory();
                },

                async loadSettings() {
                    try {
                        const res = await fetch('/api/admin/settings');
                        const result = await res.json();
                        if (result.success && result.data) {
                            const d = result.data;
                            this.config = {
                                verificationEnabled: d.verificationEnabled,
                                globalThreshold: d.globalThreshold,
                                notificationEmail: d.notificationEmail,
                                notificationSms: d.notificationSms,
                                categoryThresholds: d.categoryThresholds || { UTILITIES: 0, INTERNET: 0, INSURANCE: 0, OTHER: 0 },
                                documentTypes: d.documentTypes || []
                            };
                        }
                    } catch (e) {
                        this.showToast('error', 'Error', 'Failed to load settings');
                    }
                },

                async loadHistory() {
                    this.history.loading = true;
                    try {
                        const res = await fetch('/api/admin/settings/history');
                        const result = await res.json();
                        if (result.success) {
                            this.history.data = result.data;
                        }
                    } catch (e) {
                        console.error('History error', e);
                    } finally {
                        this.history.loading = false;
                    }
                },

                async saveSettings() {
                    if (!confirm('Apply these configuration changes?')) return;

                    this.loading = true;
                    try {
                        const res = await fetch('/api/admin/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.config)
                        });
                        const result = await res.json();
                        if (result.success) {
                            this.showToast('success', 'Saved', 'Settings saved successfully');
                            this.loadHistory();
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (e) {
                        this.showToast('error', 'Save Failed', e.message || 'Unknown error');
                    } finally {
                        this.loading = false;
                    }
                },

                runSimulation() {
                    const amount = this.simulator.amount;
                    const cat = this.simulator.category;
                    const enabled = this.config.verificationEnabled;
                    const globalThresh = this.config.globalThreshold;
                    const catThresh = this.config.categoryThresholds[cat];

                    if (!enabled) {
                        this.simulator.required = false;
                        this.simulator.reason = 'Verification is globally disabled.';
                    } else {
                        // Priority logic: Use Category if set (assuming 0 is valid strict threshold, but maybe null check implies undefined)
                        // Implementing flexible logic: if category threshold is > 0 or explicitly set, use it.
                        // For demo: effective threshold is category if defined/present, else global.

                        const effective = (catThresh !== null && catThresh !== undefined && catThresh !== 0) ? catThresh : globalThresh;

                        if (amount > effective) {
                            this.simulator.required = true;
                            this.simulator.reason = `Amount ($${amount}) exceeds ${effective === catThresh ? 'category' : 'global'} threshold ($${effective}).`;
                        } else {
                            this.simulator.required = false;
                            this.simulator.reason = `Amount ($${amount}) is within limits.`;
                        }
                    }
                    this.simulator.result = true;
                },

                resetForm() {
                    if (confirm('Discard changes?')) this.loadSettings();
                },

                formatKey(key) {
                    return key ? key.replace('payment_verification_', '').replace('admin_', '').replace(/_/g, ' ') : 'Setting';
                },

                showToast(type, title, message) {
                    this.toast.type = type;
                    this.toast.title = title;
                    this.toast.message = message;
                    this.toast.visible = true;
                    setTimeout(() => this.toast.visible = false, 3000);
                }
            }));
        });
    </script>
    </div>
    <%- include('partials/footer') %>