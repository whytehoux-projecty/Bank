<%- include('partials/header', { title: 'Security Settings' , pagePath: '/security' }) %>

    <!-- Security Settings Page Content -->
    <div class="space-y-6" x-data="securityPage()">

        <!-- Page Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h2 class="text-2xl font-display font-bold text-navy-900">Security Settings</h2>
                <p class="text-gray-600 mt-1">Manage your account security and two-factor authentication</p>
            </div>
        </div>

        <!-- Security Status Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="stat-card">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center"
                        :class="twoFactorEnabled ? 'bg-emerald-100' : 'bg-amber-100'">
                        <svg class="w-6 h-6" :class="twoFactorEnabled ? 'text-emerald-600' : 'text-amber-600'"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                    </div>
                    <div>
                        <p class="stat-label">Two-Factor Auth</p>
                        <p class="stat-value" :class="twoFactorEnabled ? 'text-emerald-600' : 'text-amber-600'"
                            x-text="twoFactorEnabled ? 'Enabled' : 'Disabled'"></p>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <div>
                        <p class="stat-label">Password</p>
                        <p class="stat-value text-blue-600">Strong</p>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="stat-label">Last Login</p>
                        <p class="stat-value text-gray-600 text-sm">Today</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two-Factor Authentication Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-navy-900">Two-Factor Authentication (2FA)</h3>
                <p class="text-sm text-gray-600 mt-1">Add an extra layer of security to your account</p>
            </div>
            <div class="card-body">
                <!-- 2FA Not Enabled -->
                <div x-show="!twoFactorEnabled && !setupMode">
                    <div class="flex items-start gap-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <div class="flex-1">
                            <h4 class="font-semibold text-amber-800">Two-Factor Authentication is not enabled</h4>
                            <p class="text-sm text-amber-700 mt-1">Enable 2FA to add an extra layer of security to your
                                account. You'll need an authenticator app like Google Authenticator or Authy.</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button @click="startSetup()" class="btn-primary">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            Enable Two-Factor Authentication
                        </button>
                    </div>
                </div>

                <!-- 2FA Setup Mode -->
                <div x-show="setupMode" x-transition>
                    <div class="max-w-lg mx-auto">
                        <!-- Step 1: Scan QR -->
                        <div x-show="setupStep === 1" class="text-center">
                            <h4 class="text-lg font-semibold text-navy-900 mb-4">Step 1: Scan QR Code</h4>
                            <p class="text-gray-600 mb-6">Use your authenticator app to scan this QR code</p>

                            <div class="inline-block p-4 bg-white rounded-lg shadow-lg mb-6" x-show="qrCode">
                                <img :src="qrCode" alt="2FA QR Code" class="w-48 h-48">
                            </div>

                            <div class="bg-gray-100 rounded-lg p-4 mb-6">
                                <p class="text-sm text-gray-600 mb-2">Or enter this code manually:</p>
                                <p class="font-mono text-sm font-bold text-navy-900 break-all" x-text="secret"></p>
                            </div>

                            <button @click="setupStep = 2" class="btn-primary">
                                Next: Verify Setup
                            </button>
                        </div>

                        <!-- Step 2: Verify -->
                        <div x-show="setupStep === 2" class="text-center">
                            <h4 class="text-lg font-semibold text-navy-900 mb-4">Step 2: Verify Setup</h4>
                            <p class="text-gray-600 mb-6">Enter the 6-digit code from your authenticator app</p>

                            <div class="max-w-xs mx-auto mb-6">
                                <input type="text" x-model="verificationCode"
                                    class="form-input text-center text-2xl tracking-widest" placeholder="000000"
                                    maxlength="6" @keyup.enter="verifySetup()">
                            </div>

                            <div class="flex justify-center gap-4">
                                <button @click="setupStep = 1" class="btn-ghost">Back</button>
                                <button @click="verifySetup()" class="btn-primary"
                                    :disabled="verificationCode.length !== 6">
                                    Verify & Enable
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Backup Codes -->
                        <div x-show="setupStep === 3">
                            <h4 class="text-lg font-semibold text-navy-900 mb-4 text-center">Step 3: Save Backup Codes
                            </h4>
                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                                <p class="text-sm text-amber-800"><strong>Important:</strong> Save these backup codes in
                                    a secure location. You can use them to access your account if you lose your phone.
                                </p>
                            </div>

                            <div class="grid grid-cols-2 gap-2 bg-gray-100 rounded-lg p-4 mb-6">
                                <template x-for="code in backupCodes" :key="code">
                                    <div class="font-mono text-sm text-center py-2 bg-white rounded" x-text="code">
                                    </div>
                                </template>
                            </div>

                            <div class="flex justify-center gap-4">
                                <button @click="downloadBackupCodes()" class="btn-ghost">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Download Codes
                                </button>
                                <button @click="finishSetup()" class="btn-primary">Done</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2FA Enabled -->
                <div x-show="twoFactorEnabled && !setupMode">
                    <div class="flex items-start gap-4 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                        <svg class="w-6 h-6 text-emerald-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        <div class="flex-1">
                            <h4 class="font-semibold text-emerald-800">Two-Factor Authentication is enabled</h4>
                            <p class="text-sm text-emerald-700 mt-1">Your account is protected with 2FA. A code from
                                your authenticator app is required to log in.</p>
                        </div>
                    </div>
                    <div class="mt-6 flex gap-4">
                        <button @click="regenerateBackupCodes()" class="btn-ghost">
                            Regenerate Backup Codes
                        </button>
                        <button @click="showDisableModal = true" class="btn-ghost text-ruby-600 hover:text-ruby-700">
                            Disable 2FA
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Password Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-navy-900">Change Password</h3>
                <p class="text-sm text-gray-600 mt-1">Update your account password</p>
            </div>
            <div class="card-body">
                <form @submit.prevent="changePassword()" class="max-w-md space-y-4">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-input" x-model="passwordForm.current" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" x-model="passwordForm.new" required minlength="8">
                        <p class="text-xs text-gray-500 mt-1">Minimum 8 characters</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" x-model="passwordForm.confirm" required>
                    </div>
                    <button type="submit" class="btn-primary">Update Password</button>
                </form>
            </div>
        </div>

        <!-- Session Management -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-navy-900">Active Sessions</h3>
                <p class="text-sm text-gray-600 mt-1">Manage your active login sessions</p>
            </div>
            <div class="card-body">
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
                                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div>
                                <p class="font-medium text-navy-900">Current Session</p>
                                <p class="text-sm text-gray-500">This device</p>
                            </div>
                        </div>
                        <span class="badge badge-success">Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function securityPage() {
            return {
                twoFactorEnabled: false,
                setupMode: false,
                setupStep: 1,
                qrCode: '',
                secret: '',
                backupCodes: [],
                verificationCode: '',
                showDisableModal: false,
                passwordForm: {
                    current: '',
                    new: '',
                    confirm: ''
                },

                async init() {
                    await this.check2FAStatus();
                },

                async check2FAStatus() {
                    try {
                        const response = await fetch('/api/extended/2fa/status');
                        const result = await response.json();
                        this.twoFactorEnabled = result.data?.enabled || false;
                    } catch (error) {
                        console.error('Failed to check 2FA status:', error);
                    }
                },

                async startSetup() {
                    try {
                        const response = await fetch('/api/extended/2fa/setup', { method: 'POST' });
                        const result = await response.json();

                        if (result.success) {
                            this.qrCode = result.data.qrCode;
                            this.secret = result.data.secret;
                            this.backupCodes = result.data.backupCodes;
                            this.setupMode = true;
                            this.setupStep = 1;
                        }
                    } catch (error) {
                        console.error('Failed to start 2FA setup:', error);
                    }
                },

                async verifySetup() {
                    try {
                        const response = await fetch('/api/extended/2fa/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                token: this.verificationCode,
                                secret: this.secret
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.setupStep = 3;
                        } else {
                            alert('Invalid verification code. Please try again.');
                        }
                    } catch (error) {
                        console.error('Failed to verify 2FA:', error);
                    }
                },

                finishSetup() {
                    this.twoFactorEnabled = true;
                    this.setupMode = false;
                    this.setupStep = 1;
                    this.verificationCode = '';
                },

                downloadBackupCodes() {
                    const content = this.backupCodes.join('\n');
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'aurum-vault-backup-codes.txt';
                    a.click();
                    URL.revokeObjectURL(url);
                },

                async regenerateBackupCodes() {
                    try {
                        const response = await fetch('/api/extended/2fa/backup-codes', { method: 'POST' });
                        const result = await response.json();

                        if (result.success) {
                            this.backupCodes = result.data.backupCodes;
                            this.setupStep = 3;
                            this.setupMode = true;
                        }
                    } catch (error) {
                        console.error('Failed to regenerate backup codes:', error);
                    }
                },

                async changePassword() {
                    if (this.passwordForm.new !== this.passwordForm.confirm) {
                        alert('Passwords do not match');
                        return;
                    }

                    try {
                        const response = await fetch('/api/auth/change-password', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                currentPassword: this.passwordForm.current,
                                newPassword: this.passwordForm.new
                            })
                        });

                        const result = await response.json();

                        if (result.message === 'Password changed successfully') {
                            alert('Password updated successfully');
                            this.passwordForm = { current: '', new: '', confirm: '' };
                        } else {
                            alert(result.error || 'Failed to update password');
                        }
                    } catch (error) {
                        console.error('Failed to change password:', error);
                    }
                }
            };
        }
    </script>

    <%- include('partials/footer') %>