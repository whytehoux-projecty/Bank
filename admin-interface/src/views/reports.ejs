<%- include('partials/header', { title: 'Reports' , pagePath: '/reports' }) %>

    <!-- Reports Page Content -->
    <div class="space-y-6" x-data="reportsPage()">

        <!-- Page Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h2 class="text-2xl font-display font-bold text-navy-900">Reports & Analytics</h2>
                <p class="text-gray-600 mt-1">Generate comprehensive reports and export data</p>
            </div>
        </div>

        <!-- Report Type Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <template x-for="report in reportTypes" :key="report.type">
                <div class="card p-6 cursor-pointer hover:border-gold-500 transition-colors"
                    :class="{ 'border-gold-500 ring-2 ring-gold-200': selectedReport === report.type }"
                    @click="selectedReport = report.type">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-lg bg-gold-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-gold-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-navy-900" x-text="report.name"></h3>
                            <p class="text-sm text-gray-600" x-text="report.description"></p>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Report Configuration -->
        <div class="card" x-show="selectedReport" x-transition>
            <div class="card-header">
                <h3 class="text-lg font-semibold text-navy-900">Configure Report</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Date Range -->
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" x-model="filters.startDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" x-model="filters.endDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Format</label>
                        <select class="form-select" x-model="format">
                            <option value="json">View in Browser (JSON)</option>
                            <option value="pdf">Download PDF</option>
                            <option value="csv">Download CSV</option>
                        </select>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" class="btn-ghost" @click="selectedReport = null">
                        Cancel
                    </button>
                    <button type="button" class="btn-primary" @click="generateReport()" :disabled="loading">
                        <span x-show="!loading">Generate Report</span>
                        <span x-show="loading" class="flex items-center gap-2">
                            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            Generating...
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Report Results -->
        <div class="card" x-show="reportData" x-transition>
            <div class="card-header flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-navy-900" x-text="reportData?.title || 'Report Results'"></h3>
                    <p class="text-sm text-gray-600"
                        x-text="reportData?.period ? `Period: ${new Date(reportData.period.start).toLocaleDateString()} - ${new Date(reportData.period.end).toLocaleDateString()}` : ''">
                    </p>
                </div>
                <div class="flex gap-2">
                    <button class="btn-sm btn-ghost" @click="downloadReport('csv')">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        CSV
                    </button>
                    <button class="btn-sm btn-ghost" @click="downloadReport('pdf')">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        PDF
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Summary Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" x-show="reportData?.summary">
                    <template x-for="(value, key) in (reportData?.summary || {})" :key="key">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600" x-text="formatLabel(key)"></p>
                            <p class="text-2xl font-bold text-navy-900" x-text="formatValue(value)"></p>
                        </div>
                    </template>
                </div>

                <!-- Data Table -->
                <div class="overflow-x-auto" x-show="reportData?.data?.length > 0">
                    <table class="table">
                        <thead class="table-head">
                            <tr>
                                <template x-for="key in Object.keys(reportData?.data?.[0] || {})" :key="key">
                                    <th class="table-th" x-text="formatLabel(key)"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(row, index) in (reportData?.data || []).slice(0, 50)" :key="index">
                                <tr class="table-row">
                                    <template x-for="(value, key) in row" :key="key">
                                        <td class="table-td" x-text="formatValue(value)"></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <p class="text-sm text-gray-500 mt-4 text-center" x-show="reportData?.data?.length > 50">
                        Showing first 50 of <span x-text="reportData?.data?.length"></span> records
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function reportsPage() {
            return {
                reportTypes: [
                    { type: 'TRANSACTION_SUMMARY', name: 'Transaction Summary', description: 'Overview of all transactions' },
                    { type: 'USER_ACTIVITY', name: 'User Activity', description: 'User engagement metrics' },
                    { type: 'KYC_STATUS', name: 'KYC Status', description: 'Verification status breakdown' },
                    { type: 'WIRE_TRANSFERS', name: 'Wire Transfers', description: 'Wire transfer processing' },
                    { type: 'AUDIT_LOG', name: 'Audit Log', description: 'System audit trail' },
                    { type: 'ACCOUNT_BALANCES', name: 'Account Balances', description: 'Current balances snapshot' },
                    { type: 'REVENUE', name: 'Revenue', description: 'Fee and revenue analysis' },
                    { type: 'COMPLIANCE', name: 'Compliance', description: 'Compliance overview' }
                ],
                selectedReport: null,
                format: 'json',
                filters: {
                    startDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    endDate: new Date().toISOString().split('T')[0]
                },
                loading: false,
                reportData: null,

                async generateReport() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/extended/reports/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                reportType: this.selectedReport,
                                format: this.format,
                                startDate: this.filters.startDate,
                                endDate: this.filters.endDate
                            })
                        });

                        if (this.format === 'json') {
                            const result = await response.json();
                            if (result.success) {
                                this.reportData = result.data;
                            }
                        } else {
                            // Download file
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `${this.selectedReport}_report.${this.format}`;
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                    } catch (error) {
                        console.error('Failed to generate report:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                async downloadReport(format) {
                    const response = await fetch('/api/extended/reports/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            reportType: this.selectedReport,
                            format: format,
                            startDate: this.filters.startDate,
                            endDate: this.filters.endDate
                        })
                    });

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedReport}_report.${format}`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                formatLabel(key) {
                    return key
                        .replace(/([A-Z])/g, ' $1')
                        .replace(/^./, str => str.toUpperCase())
                        .trim();
                },

                formatValue(value) {
                    if (typeof value === 'number') {
                        return value.toLocaleString();
                    }
                    return String(value);
                }
            };
        }
    </script>

    <%- include('partials/footer') %>