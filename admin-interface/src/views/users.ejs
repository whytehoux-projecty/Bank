<%- include('partials/header', { title: 'User Management' , pagePath: '/users' }) %>

  <div x-data="userManagement()">
    <!-- Header & actions -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
      <div>
        <!-- Breadcrumbs/Title are handled by layout, but actions go here -->
      </div>
      <button @click="openAddModal()" class="btn btn-primary group">
        <svg class="w-5 h-5 mr-2 -ml-1 transition-transform group-hover:rotate-90" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Add New User
      </button>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <%- include('partials/stat-card', { title: 'Total Users' , valueExpr: 'stats.total' , color: 'gold' , icon: `<svg
        class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
        </path>
        </svg>`
        }) %>

        <%- include('partials/stat-card', { title: 'Active Users' , valueExpr: 'stats.active' , color: 'emerald' , icon:
          `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>`
          }) %>

          <%- include('partials/stat-card', { title: 'Inactive Users' , valueExpr: 'stats.inactive' , color: 'gray' ,
            icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
            </svg>`
            }) %>

            <%- include('partials/stat-card', { title: 'New this Month' , valueExpr: 'stats.new' , color: 'navy' , icon:
              `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
              </path>
              </svg>`
              }) %>
    </div>

    <!-- Filters & Search -->
    <div class="card p-6 mb-8">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
        <div class="md:col-span-5 relative">
          <input type="text" x-model="filters.search" @input.debounce.500ms="fetchUsers()"
            placeholder="Search users by name, email, or ID..." class="form-input pl-10">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>
        <div class="md:col-span-3">
          <select x-model="filters.status" @change="fetchUsers()" class="form-select w-full">
            <option value="">All Statuses</option>
            <option value="ACTIVE">Active</option>
            <option value="INACTIVE">Inactive</option>
            <option value="SUSPENDED">Suspended</option>
          </select>
        </div>
        <div class="md:col-span-3">
          <select x-model="filters.kyc" @change="fetchUsers()" class="form-select w-full">
            <option value="">All KYC Status</option>
            <option value="PENDING">Pending</option>
            <option value="APPROVED">Approved</option>
            <option value="REJECTED">Rejected</option>
          </select>
        </div>
        <div class="md:col-span-1">
          <button @click="resetFilters()" class="btn btn-ghost w-full" title="Reset Filters">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="card overflow-hidden">
      <%- include('partials/table', { loadingVar: 'loading' , emptyCheck: '!loading && users.length === 0' ,
        emptyMessage: 'No users found matching criteria' , colCount: 5, loopVar: 'user in users' , keyVar: 'user.id' ,
        headerHtml: ` <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-left">User</th>
        <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-left">Role</th>
        <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-left">Status</th>
        <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-left">Joined</th>
        <th class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">Actions</th>
        `,
        rowHtml: `
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center">
            <div class="h-10 w-10 rounded-full bg-navy-700 flex items-center justify-center text-white font-bold"
              x-text="user.firstName.charAt(0) + user.lastName.charAt(0)"></div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900" x-text="user.firstName + ' ' + user.lastName"></div>
              <div class="text-sm text-gray-500" x-text="user.email"></div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
            User
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" :class="{
                  'bg-green-100 text-green-800': user.status === 'ACTIVE',
                  'bg-red-100 text-red-800': user.status === 'INACTIVE',
                  'bg-yellow-100 text-yellow-800': user.status === 'SUSPENDED'
                }" x-text="user.status">
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
          x-text="new Date(user.createdAt).toLocaleDateString()"></td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
          <button @click="editUser(user)" class="text-navy-600 hover:text-navy-900 mr-3">Edit</button>
          <button @click="deleteUser(user)" class="text-red-600 hover:text-red-900">Delete</button>
        </td>
        `
        }) %>

        <!-- Pagination (Mock) -->
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex items-center justify-between">
          <span class="text-sm text-gray-500">Showing <span class="font-medium" x-text="users.length"></span>
            results</span>
          <div class="flex gap-2">
            <button class="btn btn-sm btn-ghost" disabled>Previous</button>
            <button class="btn btn-sm btn-ghost" disabled>Next</button>
          </div>
        </div>
    </div>


    <!-- Add/Edit User Modal -->
    <div x-show="showModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;" x-transition.opacity>
      <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="closeModal()"></div>

        <div
          class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-display font-bold text-navy-900"
                x-text="modalMode === 'add' ? 'Add New User' : 'Edit User'"></h3>
              <button @click="closeModal()" class="text-gray-400 hover:text-gray-500">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="form-label">First Name</label>
                  <input type="text" x-model="formData.firstName" class="form-input">
                </div>
                <div>
                  <label class="form-label">Last Name</label>
                  <input type="text" x-model="formData.lastName" class="form-input">
                </div>
              </div>
              <div>
                <label class="form-label">Email Address</label>
                <input type="email" x-model="formData.email" class="form-input">
              </div>
              <div>
                <label class="form-label">Status</label>
                <select x-model="formData.status" class="form-select w-full">
                  <option value="ACTIVE">Active</option>
                  <option value="INACTIVE">Inactive</option>
                  <option value="SUSPENDED">Suspended</option>
                </select>
              </div>
            </div>
          </div>

          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button @click="saveUser()" class="btn btn-primary ml-3">Save User</button>
            <button @click="closeModal()" class="btn btn-ghost">Cancel</button>
          </div>
        </div>
      </div>
    </div>


  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('userManagement', () => ({
        users: [],
        loading: true,
        stats: { total: 0, active: 0, inactive: 0, new: 0 },
        filters: { search: '', status: '', kyc: '' },
        showModal: false,
        modalMode: 'add',
        formData: { firstName: '', lastName: '', email: '', status: 'ACTIVE' },

        init() {
          this.fetchUsers();
        },

        async fetchUsers() {
          this.loading = true;
          try {
            // Build query string
            const params = new URLSearchParams();
            if (this.filters.search) params.append('search', this.filters.search);
            if (this.filters.status) params.append('status', this.filters.status);

            const response = await fetch('/api/admin/users?' + params.toString());
            const data = await response.json();

            this.users = data.users || [];

            // Calculate stats from data (in real app, API should return this)
            this.stats.total = this.users.length;
            this.stats.active = this.users.filter(u => u.status === 'ACTIVE').length;
            this.stats.inactive = this.users.filter(u => u.status === 'INACTIVE').length;
            this.stats.new = this.users.filter(u => {
              const date = new Date(u.createdAt);
              const now = new Date();
              return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;

          } catch (error) {
            console.error('Error fetching users:', error);
          } finally {
            this.loading = false;
          }
        },

        getInitials(user) {
          return (user.firstName?.charAt(0) || '') + (user.lastName?.charAt(0) || '');
        },

        getFullname(user) {
          return `${user.firstName} ${user.lastName}`;
        },

        formatDate(dateString) {
          if (!dateString) return 'N/A';
          return new Date(dateString).toLocaleDateString();
        },

        resetFilters() {
          this.filters = { search: '', status: '', kyc: '' };
          this.fetchUsers();
        },

        openAddModal() {
          this.modalMode = 'add';
          this.formData = { firstName: '', lastName: '', email: '', status: 'ACTIVE' };
          this.showModal = true;
        },

        editUser(user) {
          this.modalMode = 'edit';
          this.formData = { ...user };
          this.showModal = true;
        },

        closeModal() {
          this.showModal = false;
        },

        async saveUser() {
          try {
            const url = this.modalMode === 'add' ? '/api/admin/users' : `/api/admin/users/${this.formData.id}`;
            const method = this.modalMode === 'add' ? 'POST' : 'PUT';

            const response = await fetch(url, {
              method,
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(this.formData)
            });

            if (!response.ok) {
              const data = await response.json();
              throw new Error(data.error || 'Failed to save user');
            }

            this.closeModal();
            this.fetchUsers();
          } catch (error) {
            console.error('Error saving user:', error);
            alert(error.message);
          }
        },

        async deleteUser(user) {
          if (confirm('Are you sure you want to delete ' + (user.firstName + ' ' + user.lastName) + '?')) {
            try {
              const response = await fetch(`/api/admin/users/${user.id}`, {
                method: 'DELETE'
              });

              if (!response.ok) throw new Error('Failed to delete user');

              this.fetchUsers();
            } catch (error) {
              console.error('Error deleting user:', error);
              alert('Failed to delete user');
            }
          }
        },

        viewUser(user) {
          alert('Viewing user details functionality coming soon');
        }
      }));
    });
  </script>

  <%- include('partials/footer') %>