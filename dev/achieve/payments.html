<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Payments - Staff Portal" />
  <title>Payments | Staff Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <link rel="stylesheet" href="css/dashboard-enhanced.css" />
  <style>
    /* Finance Page Specific Styles */
    :root {
      --card-bg: #ffffff;
      --card-border: rgba(0, 0, 0, 0.04);
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.04),
        0 1px 2px rgba(0, 0, 0, 0.02);
      --card-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Page Header */
    .finance-header {
      background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(26, 54, 93, 0.3);
    }

    .finance-header h1 {
      color: #fff;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .finance-header p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.875rem;
      margin: 4px 0 0;
    }

    .finance-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 0;
    }

    .finance-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.2s;
    }

    .finance-tab:hover {
      color: #1a365d;
    }

    .finance-tab.active {
      color: #1a365d;
      border-bottom-color: #e53e3e;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
    }

    .stat-card.primary::before {
      background: #1a365d;
    }

    .stat-card.success::before {
      background: #38a169;
    }

    .stat-card.warning::before {
      background: #dd6b20;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      margin-bottom: 12px;
    }

    .stat-card.primary .stat-icon {
      background: #ebf4ff;
    }

    .stat-card.success .stat-icon {
      background: #f0fff4;
    }

    .stat-card.warning .stat-icon {
      background: #fffaf0;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #64748b;
    }

    /* Loans Section */
    .loans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .loan-card {
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
      transition: var(--transition-smooth);
    }

    .loan-card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }

    .loan-card-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, #f8fafc, #fff);
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .loan-card-header h4 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: #1e293b;
    }

    .loan-card-body {
      padding: 20px;
    }

    .loan-progress {
      margin-bottom: 16px;
    }

    .loan-progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .loan-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #38a169, #68d391);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .loan-progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #64748b;
    }

    .loan-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .loan-detail {
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .loan-detail-label {
      font-size: 0.65rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .loan-detail-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1e293b;
    }

    .loan-actions {
      display: flex;
      gap: 8px;
    }

    .loan-actions .btn {
      flex: 1;
      font-size: 0.8rem;
      padding: 10px 12px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.1rem;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 0.875rem;
      margin-bottom: 20px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-container {
      background: #fff;
      border-radius: 20px;
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      margin: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc, #fff);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: #f1f5f9;
      color: #64748b;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #e2e8f0;
      color: #1e293b;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: #f8fafc;
    }

    /* Invoice Styles */
    .invoice-container {
      background: #fff;
      border: 2px solid #1a365d;
      border-radius: 12px;
      overflow: hidden;
    }

    .invoice-header {
      background: linear-gradient(135deg, #1a365d, #2c5282);
      color: #fff;
      padding: 24px;
      text-align: center;
    }

    .invoice-header h2 {
      margin: 0 0 4px;
      font-size: 1.25rem;
    }

    .invoice-header p {
      margin: 0;
      opacity: 0.8;
      font-size: 0.875rem;
    }

    .invoice-body {
      padding: 24px;
    }

    .invoice-section {
      margin-bottom: 24px;
    }

    .invoice-section:last-child {
      margin-bottom: 0;
    }

    .invoice-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #e2e8f0;
    }

    .invoice-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.875rem;
    }

    .invoice-row .label {
      color: #64748b;
    }

    .invoice-row .value {
      font-weight: 600;
      color: #1e293b;
    }

    .invoice-total {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .invoice-total .invoice-row {
      font-size: 1.1rem;
    }

    .invoice-total .value {
      color: #e53e3e;
      font-size: 1.25rem;
    }

    .invoice-bank-details {
      background: #fffaf0;
      border: 1px solid #feebc8;
      border-radius: 8px;
      padding: 16px;
    }

    .invoice-bank-details h4 {
      color: #dd6b20;
      font-size: 0.8rem;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .invoice-pin {
      background: #1a365d;
      color: #fff;
      text-align: center;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .invoice-pin-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .invoice-pin-value {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 4px;
      font-family: monospace;
    }

    /* Payment Amount Selector */
    .payment-options {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .payment-option {
      flex: 1;
      padding: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .payment-option:hover {
      border-color: #1a365d;
    }

    .payment-option.selected {
      border-color: #1a365d;
      background: #ebf4ff;
    }

    .payment-option-label {
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 4px;
    }

    .payment-option-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1e293b;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1a365d;
      box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
    }

    .form-hint {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 6px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .finance-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .loans-grid {
        grid-template-columns: 1fr;
      }

      .loan-details {
        grid-template-columns: 1fr;
      }
    }

    /* New Payment Modal Styles */
    .payment-options-radio {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .payment-radio-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .payment-radio-option:hover {
      border-color: #cbd5e1;
      background: #f8fafc;
    }

    .payment-radio-option input[type="radio"] {
      margin-top: 4px;
      accent-color: #1a365d;
      width: 18px;
      height: 18px;
    }

    /* Active state handled by :has if desired, but we rely on click handlers for older browser compatibility or use checked selector */
    .payment-radio-option:has(input:checked),
    .payment-radio-option input:checked+* {
      border-color: #1a365d;
      background: #f0f7ff;
    }

    /* Fallback for :has if needed - simple logic handles visually via :checked sibling specific logic usually or JS */

    .radio-content {
      flex: 1;
    }

    .radio-title {
      display: block;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .radio-desc {
      display: block;
      font-size: 0.8rem;
      color: #64748b;
    }

    .radio-price {
      font-weight: 700;
      color: #1a365d;
    }

    .input-with-prefix {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-with-prefix span {
      position: absolute;
      left: 12px;
      color: #64748b;
      font-weight: 600;
    }

    .input-with-prefix input {
      padding-left: 28px;
    }
  </style>
</head>

<body>
  <!-- Navigation Header -->
  <header class="main-header">
    <div class="header-left">
      <div class="org-logo-small">
        <img src="assets/logo.svg" alt="Staff Portal" />
      </div>
      <h1 class="portal-title">Staff Portal</h1>
    </div>

    <nav class="main-nav">
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="my-contract.html" class="nav-link">My Contract</a>
      <a href="payments.html" class="nav-link active">Payslips &amp; Payments</a>
      <a href="requests.html" class="nav-link">Requests</a>
      <a href="notifications.html" class="nav-link">Notifications</a>
      <a href="account.html" class="nav-link">Account</a>
    </nav>

    <div class="header-right">
      <button class="icon-btn" title="Notifications" aria-label="Notifications"
        onclick="window.location.href='notifications.html'">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path
            d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
        </svg>
        <span class="badge">3</span>
      </button>

      <div class="user-menu">
        <button class="user-btn" onclick="toggleUserMenu()" aria-label="User menu">
          <div class="avatar" id="headerAvatar"></div>
          <span id="headerName"></span>
          <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
            <path d="M6 8L2 4h8L6 8z" />
          </svg>
        </button>
        <div class="dropdown-menu" id="userDropdown">
          <a href="account.html">Account</a>
          <hr />
          <a href="#" onclick="logout()">Logout</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <section class="page-title-card">
      <div class="page-title-text">
        <h1>Payslips &amp; Payments</h1>
        <p>Payslips, payment history, and loans</p>
      </div>
      <div class="page-title-actions">
        <button class="btn btn-accent btn-sm" onclick="openLoanModal()">
          + New Loan Application
        </button>
      </div>
    </section>

    <!-- Tabs -->
    <div class="finance-tabs">
      <button class="finance-tab active" onclick="switchTab('payroll')">
        üßæ Payslips & History
      </button>
      <button class="finance-tab" onclick="switchTab('loans')">
        üí≥ Loans & Grants
      </button>
      <button class="finance-tab" onclick="switchTab('benefits')">
        üéÅ Benefits
      </button>
    </div>

    <!-- Payroll Tab -->
    <div id="payroll-tab" class="tab-content active">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="stat-icon">üíµ</div>
          <div class="stat-value" id="lastNetPay">-</div>
          <div class="stat-label">Last Net Pay</div>
        </div>
        <div class="stat-card success">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-value" id="nextPayDate">-</div>
          <div class="stat-label">Next Pay Date</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-icon">üìà</div>
          <div class="stat-value" id="ytdEarnings">-</div>
          <div class="stat-label">YTD Earnings</div>
        </div>
      </div>

      <!-- Payroll History -->
      <div class="panel-card">
        <div class="panel-card-header">
          <h3 class="panel-card-title">üìã Payroll History</h3>
          <div class="panel-card-actions">
            <button class="btn btn-secondary btn-sm" onclick="downloadPayrollReport()">
              Download Report
            </button>
          </div>
        </div>
        <div class="panel-card-body" style="padding: 0">
          <table class="data-table">
            <thead>
              <tr>
                <th>Period</th>
                <th>Pay Date</th>
                <th>Gross Pay</th>
                <th>Deductions</th>
                <th>Net Pay</th>
                <th>Payslip</th>
              </tr>
            </thead>
            <tbody id="payrollBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Loans Tab -->
    <div id="loans-tab" class="tab-content">
      <!-- Loan Stats -->
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="stat-icon">üí≥</div>
          <div class="stat-value" id="activeLoansCount">0</div>
          <div class="stat-label">Active Loans</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-icon">üí∞</div>
          <div class="stat-value" id="totalOutstanding">-</div>
          <div class="stat-label">Total Outstanding</div>
        </div>
        <div class="stat-card success">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-value" id="totalPaid">-</div>
          <div class="stat-label">Total Paid</div>
        </div>
      </div>

      <!-- Active Loans -->
      <div class="panel-card" style="margin-bottom: 24px">
        <div class="panel-card-header">
          <h3 class="panel-card-title">üìä My Active Loans & Grants</h3>
          <div class="panel-card-actions">
            <button class="btn btn-secondary btn-sm" onclick="openLoanModal()">
              + New Loan Application
            </button>
          </div>
        </div>
        <div class="panel-card-body">
          <div class="loans-grid" id="loansGrid">
            <!-- Loans will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Benefits Tab -->
    <div id="benefits-tab" class="tab-content">
      <div class="panel-card">
        <div class="panel-card-header">
          <h3 class="panel-card-title">üéÅ Staff Benefits</h3>
        </div>
        <div class="panel-card-body">
          <div class="empty-state">
            <div class="empty-state-icon">üéÅ</div>
            <h3>Benefits Information</h3>
            <p>Your benefits package information will appear here.</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Loan Application Modal -->
  <div id="loanModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3>üí∞ Apply for Staff Loan</h3>
        <button class="modal-close" onclick="closeLoanModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form id="loanForm">
          <div class="form-group">
            <label>Loan Amount</label>
            <input type="number" id="loanAmount" placeholder="Enter amount" required min="100" />
            <div class="form-hint">Minimum: $100 | Maximum: $50,000</div>
          </div>
          <div class="form-group">
            <label>Loan Purpose</label>
            <select id="loanPurpose" required>
              <option value="">Select purpose...</option>
              <option value="emergency">Emergency/Medical</option>
              <option value="education">Education</option>
              <option value="housing">Housing/Rent</option>
              <option value="vehicle">Vehicle</option>
              <option value="personal">Personal</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Repayment Period</label>
            <select id="loanTerm" required>
              <option value="">Select period...</option>
              <option value="3">3 Months</option>
              <option value="6">6 Months</option>
              <option value="12">12 Months</option>
              <option value="24">24 Months</option>
              <option value="36">36 Months</option>
            </select>
          </div>
          <div class="form-group">
            <label>Reason / Details</label>
            <textarea id="loanReason" rows="3"
              placeholder="Please provide details about why you need this loan..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeLoanModal()">
          Cancel
        </button>
        <button class="btn btn-primary" onclick="submitLoanApplication()">
          Submit Application
        </button>
      </div>
    </div>
  </div>

  <!-- Loan Details Modal -->
  <div id="loanDetailsModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 800px">
      <div class="modal-header">
        <h3>üìÑ Loan Details & History</h3>
        <button class="modal-close" onclick="closeLoanDetailsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="loanDetailsContent">Loading...</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeLoanDetailsModal()">Close</button>
        <button id="btnDownloadHistory" class="btn btn-primary" onclick="downloadLoanHistory()">Download History
          (PDF)</button>
      </div>
    </div>
  </div>

  <!-- Make Payment Modal -->
  <div id="paymentModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3>üí≥ Make Loan Payment</h3>
        <button class="modal-close" onclick="closePaymentModal()">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Loan Details</label>
          <div id="paymentLoanDetails" style="background:#f8fafc; padding:12px; border-radius:8px; font-size:0.9rem;">
            <!-- Populated by JS -->
          </div>
        </div>

        <div class="form-group">
          <label style="margin-bottom:12px; display:block;">Select Payment Type</label>
          <div class="payment-options-radio">
            <label class="payment-radio-option" onclick="selectPaymentType('full')">
              <input type="radio" name="paymentType" value="full" checked onchange="handlePaymentTypeChange()">
              <div class="radio-content">
                <span class="radio-title">Full Repayment</span>
                <span class="radio-desc">Pay off the entire outstanding balance.</span>
              </div>
              <span class="radio-price" id="fullPaymentAmountDisplay">$0.00</span>
            </label>

            <label class="payment-radio-option" onclick="selectPaymentType('partial')">
              <input type="radio" name="paymentType" value="partial" onchange="handlePaymentTypeChange()">
              <div class="radio-content">
                <span class="radio-title">Partial Repayment</span>
                <span class="radio-desc">Pay a specific amount towards your loan.</span>
              </div>
            </label>
          </div>
        </div>

        <div class="form-group" id="partialAmountGroup" style="display: none; margin-top:16px;">
          <label>Partial Amount</label>
          <div class="input-with-prefix">
            <span>$</span>
            <input type="number" id="customPaymentAmount" placeholder="Enter amount" min="1" />
          </div>
          <div class="form-hint" id="paymentValidationHint">Enter an amount less than the total balance.</div>
        </div>

        <div id="paymentError" style="color:#e53e3e; font-size:0.85rem; margin-top:10px; display:none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePaymentModal()">
          Cancel
        </button>
        <button id="btnGenerateInvoice" class="btn btn-accent" onclick="generatePaymentInvoice()">
          Generate Invoice
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Invoice Modal -->
  <div id="invoiceModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 480px">
      <div class="modal-header">
        <h3>üìÑ Payment Invoice</h3>
        <button class="modal-close" onclick="closeInvoiceModal()">
          &times;
        </button>
      </div>
      <div class="modal-body" style="padding: 0">
        <div class="invoice-container" id="invoiceContent">
          <!-- Invoice content will be generated here -->
        </div>
      </div>
      <!-- The modal-footer will be dynamically generated inside invoiceContent -->
    </div>
  </div>

  <!-- Footer -->
  <footer class="main-footer">
    <div class="footer-content">
      <p>&copy; 2026 Global Organization. All rights reserved.</p>
      <div class="footer-links">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
        <a href="#">Help & Support</a>
      </div>
    </div>
  </footer>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/common.js"></script>
  <script>
    // Store loans data
    let loansData = [];
    let selectedLoan = null;
    let paymentAmount = 0;

    // Utility functions
    const safe = (v) => (v === undefined || v === null ? "" : String(v));
    const fmtDate = (d) =>
      d ? new Date(d).toLocaleDateString("en-US") : "-";
    const fmtMoney = (amount, currency = "USD") => {
      if (amount === undefined || amount === null) return "-";
      const n = typeof amount === "string" ? Number(amount) : amount;
      if (Number.isNaN(n)) return safe(amount);
      return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency,
      }).format(n);
    };

    const monthName = (month) =>
      new Date(2000, Math.max(0, (month || 1) - 1), 1).toLocaleString(
        "en-US",
        {
          month: "long",
        }
      );

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll(".finance-tab").forEach((tab) => {
        tab.classList.remove("active");
      });
      document.querySelectorAll(".tab-content").forEach((content) => {
        content.classList.remove("active");
      });

      event.target.classList.add("active");
      document.getElementById(`${tabName}-tab`).classList.add("active");
    }

    // User menu
    function toggleUserMenu() {
      document.getElementById("userDropdown").classList.toggle("show");
    }

    // Payment UI state
    let currentPaymentType = 'full';

    // Loan Modal
    function openLoanModal() {
      document.getElementById("loanModal").classList.add("show");
    }

    function closeLoanModal() {
      document.getElementById("loanModal").classList.remove("show");
      document.getElementById("loanForm").reset();
    }

    // Payment Modal
    function openPaymentModal(loanId) {
      selectedLoan = loansData.find((l) => l.id === loanId);
      if (!selectedLoan) return;

      // Reset state
      currentPaymentType = 'full';
      document.querySelectorAll('input[name="paymentType"][value="full"]').forEach(r => r.checked = true);
      document.getElementById("customPaymentAmount").value = '';
      document.getElementById("paymentError").style.display = 'none';

      // Populate Details
      document.getElementById("paymentLoanDetails").innerHTML = `
           <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
               <span style="color:#64748b;">Loan Reference:</span>
               <span style="font-weight:600;">${selectedLoan.reason || 'Loan'}</span>
           </div>
           <div style="display:flex; justify-content:space-between;">
               <span style="color:#64748b;">Outstanding Balance:</span>
               <span style="font-weight:700; color:#1e293b;">${fmtMoney(selectedLoan.balance)}</span>
           </div>
        `;

      document.getElementById("fullPaymentAmountDisplay").textContent = fmtMoney(selectedLoan.balance);
      handlePaymentTypeChange(); // Set initial visibility

      document.getElementById("paymentModal").classList.add("show");
    }

    function closePaymentModal() {
      document.getElementById("paymentModal").classList.remove("show");
    }

    function selectPaymentType(type) {
      // Just a helper for clicking the container
      const radio = document.querySelector(`input[name="paymentType"][value="${type}"]`);
      if (radio) {
        radio.checked = true;
        handlePaymentTypeChange();
      }
    }

    function handlePaymentTypeChange() {
      const type = document.querySelector('input[name="paymentType"]:checked').value;
      currentPaymentType = type;

      if (type === 'partial') {
        document.getElementById("partialAmountGroup").style.display = 'block';
        document.getElementById("customPaymentAmount").focus();
      } else {
        document.getElementById("partialAmountGroup").style.display = 'none';
      }
      document.getElementById("paymentError").style.display = 'none';
    }

    // Invoice Generation
    async function generatePaymentInvoice() {
      let amountToPay = 0;
      const balance = Number(selectedLoan.balance);

      if (currentPaymentType === 'full') {
        amountToPay = balance;
      } else {
        const customInput = document.getElementById("customPaymentAmount").value;
        amountToPay = Number(customInput);
      }

      // Validation
      const errorDiv = document.getElementById("paymentError");
      if (!amountToPay || amountToPay <= 0) {
        errorDiv.textContent = "Please enter a valid amount greater than 0.";
        errorDiv.style.display = 'block';
        return;
      }
      if (amountToPay > balance) {
        errorDiv.textContent = `Amount cannot exceed the outstanding balance of ${fmtMoney(balance)}.`;
        errorDiv.style.display = 'block';
        return;
      }

      // Generate Invoice via API
      const btn = document.getElementById("btnGenerateInvoice");
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "Generating...";
      errorDiv.style.display = 'none';

      try {
        const res = await API.request(`/finance/loans/${selectedLoan.id}/invoice`, {
          method: 'POST',
          auth: true,
          body: { amount: amountToPay }
        });

        if (res.success && res.data) {
          displayInvoice(res.data);
          closePaymentModal();
        } else {
          throw new Error(res.message || 'Failed to generate invoice');
        }
      } catch (err) {
        console.error("Invoice Error:", err);
        errorDiv.textContent = err.message || "Failed to generate invoice. Please try again.";
        errorDiv.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function displayInvoice(invoiceData) {
      document.getElementById("invoiceContent").innerHTML = `
          <div id="invoiceToPrint">
            <div class="invoice-header">
              <h2>PAYMENT INVOICE</h2>
              <p>Invoice #${invoiceData.invoiceNumber}</p>
            </div>
            <div class="invoice-body">
              <div class="invoice-section">
                <div class="invoice-section-title">Payment Details</div>
                <div class="invoice-row">
                  <span class="label">Loan Reference</span>
                  <span class="value">${invoiceData.loan.id || "N/A"}</span>
                </div>
                <div class="invoice-row">
                  <span class="label">Loan Purpose</span>
                  <span class="value">${invoiceData.loan.reason || "Staff Loan"}</span>
                </div>
                <div class="invoice-row">
                  <span class="label">Generated Date</span>
                  <span class="value">${new Date(invoiceData.generatedAt).toLocaleDateString("en-US", {
        year: "numeric", month: "long", day: "numeric"
      })}</span>
                </div>
                <div class="invoice-row">
                  <span class="label">Due Date</span>
                  <span class="value">${new Date(invoiceData.dueDate).toLocaleDateString("en-US", {
        year: "numeric", month: "long", day: "numeric"
      })}</span>
                </div>
              </div>

              <div class="invoice-section">
                <div class="invoice-section-title">Amount Breakdown</div>
                <div class="invoice-row">
                  <span class="label">Principal Amount</span>
                  <span class="value">${fmtMoney(invoiceData.amounts?.principal || invoiceData.loan.paymentAmount)}</span>
                </div>
                ${invoiceData.amounts?.tax > 0 ? `
                <div class="invoice-row">
                  <span class="label">Tax</span>
                  <span class="value">${fmtMoney(invoiceData.amounts.tax)}</span>
                </div>
                ` : ''}
                ${invoiceData.amounts?.fee > 0 ? `
                <div class="invoice-row">
                  <span class="label">Fees</span>
                  <span class="value">${fmtMoney(invoiceData.amounts.fee)}</span>
                </div>
                ` : ''}
                <div class="invoice-total">
                  <div class="invoice-row">
                    <span class="label"><strong>Total Due</strong></span>
                    <span class="value">${fmtMoney(invoiceData.amounts?.total || invoiceData.loan.paymentAmount)}</span>
                  </div>
                </div>
              </div>

              <div class="invoice-section">
                 <div class="invoice-section-title">Scan to Pay</div>
                 <div style="display:flex; justify-content:center; padding:10px;">
                    <div id="qrcode"></div>
                 </div>
                 <p style="text-align:center; font-size:0.8rem; color:#64748b; margin-top:5px;">Scan this code at the bank terminal</p>
              </div>

              <div class="invoice-section">
                <div class="invoice-section-title">Bank Transfer Details</div>
                <div class="invoice-bank-details">
                  <h4>üè¶ Payment Instructions</h4>
                  <div class="invoice-row">
                    <span class="label">Account Name</span>
                    <span class="value">${invoiceData.bankDetails.accountName}</span>
                  </div>
                  <div class="invoice-row">
                    <span class="label">Bank Name</span>
                    <span class="value">${invoiceData.bankDetails.bankName}</span>
                  </div>
                  <div class="invoice-row">
                    <span class="label">Account Number</span>
                    <span class="value">${invoiceData.bankDetails.accountNumber}</span>
                  </div>
                  <div class="invoice-row">
                     <span class="label">Service Code</span>
                     <span class="value">${invoiceData.serviceCode || "UHI-2134"}</span>
                  </div>
                  <div class="invoice-row">
                     <span class="label">Reference Code</span>
                     <span class="value">${invoiceData.accountCode || "G/L/..."}</span>
                  </div>
                </div>
              </div>

              <div class="invoice-section">
                <div class="invoice-section-title">Payment Reference</div>
                <p style="font-size: 0.85rem; color: #64748b; margin: 0 0 12px;">
                  Use the PIN below as your payment reference. This ensures your payment is correctly applied to your loan account.
                </p>
                <div class="invoice-pin">
                  <div class="invoice-pin-label">Payment Reference PIN</div>
                  <div class="invoice-pin-value">${invoiceData.paymentPin}</div>
                </div>
              </div>

              <div style="text-align:center; margin-top:20px; font-size:0.8rem; color:#94a3b8;">
                 This invoice is valid until ${new Date(invoiceData.dueDate).toLocaleDateString()}.
              </div>
            </div>
          </div>
          <div class="modal-footer" style="flex-direction:row; gap:10px; padding-top:20px; border-top:1px solid #e2e8f0; margin-top:20px;">
             <button class="btn btn-secondary" onclick="closeInvoiceModal()">Close</button>
             <button class="btn btn-secondary" onclick="printInvoice()">Print</button>
             <button class="btn btn-primary" onclick="downloadInvoicePDF('${invoiceData.invoiceNumber}')">Download PDF</button>
          </div>
        `;

      // Render QR Code
      if (invoiceData.qrContent) {
        setTimeout(() => {
          new QRCode(document.getElementById("qrcode"), {
            text: invoiceData.qrContent,
            width: 128,
            height: 128,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        }, 100);
      }

      document.getElementById("invoiceModal").classList.add("show");
    }

    function closeInvoiceModal() {
      document.getElementById("invoiceModal").classList.remove("show");
    }


    function printInvoice() {
      const content = document.getElementById("invoiceToPrint").innerHTML;
      const win = window.open('', '', 'height=700,width=900');
      win.document.write('<html><head><title>Invoice</title>');
      // Add styles for printing
      win.document.write(`
             <style>
               body { font-family: 'Inter', sans-serif; padding: 20px; }
               .invoice-header { text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 20px; }
               .invoice-header h2 { margin: 0; color: #1e293b; font-size: 1.5rem; }
               .invoice-header p { margin: 5px 0 0; color: #64748b; }
               .invoice-section { margin-bottom: 24px; }
               .invoice-section-title { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 12px; }
               .invoice-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
               .invoice-row .label { color: #64748b; }
               .invoice-row .value { font-weight: 500; color: #1e293b; text-align: right; }
               .invoice-total { margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e2e8f0; }
               .invoice-bank-details { background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; }
               .invoice-pin { background: #eff6ff; border: 2px dashed #3b82f6; border-radius: 8px; padding: 16px; text-align: center; }
               .invoice-pin-label { font-size: 0.8rem; font-weight: 600; color: #1d4ed8; text-transform: uppercase; }
               .invoice-pin-value { font-family: monospace; font-size: 1.5rem; font-weight: 700; color: #1e40af; letter-spacing: 2px; margin-top: 4px; }
               #qrcode img { margin: 0 auto; } 
             </style>
          `);
      win.document.write('</head><body>');
      win.document.write(content);
      win.document.write('</body></html>');
      win.document.close();
      win.print();
    }

    function downloadInvoicePDF(filename) {
      const element = document.getElementById("invoiceToPrint");
      const opt = {
        margin: 0.5,
        filename: `${filename}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }

    // Submit loan application
    async function submitLoanApplication() {
      const amount = document.getElementById("loanAmount").value;
      const purpose = document.getElementById("loanPurpose").value;
      const term = document.getElementById("loanTerm").value;
      const reason = document.getElementById("loanReason").value;

      if (!amount || !purpose || !term) {
        alert("Please fill in all required fields");
        return;
      }

      try {
        await API.request("/finance/loans", {
          method: "POST",
          auth: true,
          body: { amount, purpose, term, reason },
        });
        closeLoanModal();
        await loadLoans();
        alert("Loan application submitted successfully!");
      } catch (error) {
        console.error("Error submitting loan:", error);
        alert("Failed to submit loan application. Please try again.");
      }
    }

    // Load payroll data
    async function loadPayroll() {
      try {
        const payrollRes = await API.request("/finance/payroll", {
          auth: true,
        });
        const records = Array.isArray(payrollRes?.data)
          ? payrollRes.data
          : [];

        const payrollBody = document.getElementById("payrollBody");
        if (payrollBody) {
          payrollBody.innerHTML = "";
          if (records.length === 0) {
            payrollBody.innerHTML =
              '<tr><td colspan="6" style="text-align: center; color: #64748b; padding: 40px;">No payroll records found</td></tr>';
          } else {
            for (const r of records) {
              const tr = document.createElement("tr");
              const period = `${monthName(r.period_month)} ${safe(
                r.period_year
              )}`;
              tr.innerHTML = `
                  <td>${safe(period)}</td>
                  <td>${fmtDate(r.payment_date)}</td>
                  <td>${fmtMoney(r.basic_salary, r.currency)}</td>
                  <td>${fmtMoney(r.deductions, r.currency)}</td>
                  <td><strong>${fmtMoney(r.net_pay, r.currency)}</strong></td>
                  <td><button class="btn btn-sm btn-secondary" onclick="downloadPayslip('${r.id
                }')">Download</button></td>
                `;
              payrollBody.appendChild(tr);
            }
          }
        }

        const latest = records[0];
        document.getElementById("lastNetPay").textContent = latest
          ? fmtMoney(latest.net_pay, latest.currency)
          : "-";

        // Calculate next pay date (25th of next month)
        const nextPay = new Date();
        nextPay.setMonth(nextPay.getMonth() + 1);
        nextPay.setDate(25);
        document.getElementById("nextPayDate").textContent = fmtDate(nextPay);

        const year = new Date().getFullYear();
        const ytd = records
          .filter((r) => Number(r.period_year) === year)
          .reduce((sum, r) => sum + Number(r.net_pay || 0), 0);
        document.getElementById("ytdEarnings").textContent = ytd
          ? fmtMoney(ytd, latest?.currency || "USD")
          : "-";
      } catch (error) {
        console.error("Error loading payroll:", error);
      }
    }

    // Load loans and grants data
    async function loadFinancials() {
      try {
        const [loansRes, grantsRes] = await Promise.all([
          API.request("/finance/loans", { auth: true }),
          API.request("/finance/grants", { auth: true }).catch(() => ({ data: [] }))
        ]);

        loansData = Array.isArray(loansRes?.data) ? loansRes.data : [];
        const grantsData = Array.isArray(grantsRes?.data) ? grantsRes.data : [];

        // Normalize and merge
        const allItems = [
          ...loansData.map(l => ({ ...l, type: 'loan', date: l.created_at })),
          ...grantsData.map(g => ({ ...g, type: 'grant', date: g.created_at }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date));

        const loansGrid = document.getElementById("loansGrid");
        if (loansGrid) {
          if (allItems.length === 0) {
            loansGrid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                  <div class="empty-state-icon">üí≥</div>
                  <h3>No Active Loans or Grants</h3>
                  <p>You don't have any financial records yet.</p>
                  <button class="btn btn-primary" onclick="openLoanModal()">Apply for Loan</button>
                </div>
              `;
          } else {
            loansGrid.innerHTML = allItems
              .map((item) => {
                const isLoan = item.type === 'loan';
                const progress = isLoan && item.amount > 0
                  ? ((item.amount - item.balance) / item.amount) * 100
                  : 100; // Grants are "complete"

                let statusClass = 'pending';
                if (item.status === 'active' || item.status === 'disbursed') statusClass = 'active';
                else if (item.status === 'approved') statusClass = 'approved';
                else if (item.status === 'paid_off' || item.status === 'completed') statusClass = 'completed';

                // Badge Text
                const badgeText = isLoan ? item.status : (item.status === 'disbursed' ? 'Granted' : item.status);

                return `
                  <div class="loan-card">
                    <div class="loan-card-header">
                      <div style="display:flex; flex-direction:column;">
                         <h4>${item.reason || (isLoan ? "Staff Loan" : "Staff Grant")}</h4>
                         <span style="font-size:0.7rem; color:#64748b; text-transform:uppercase;">${isLoan ? 'Repayable Loan' : 'Non-Repayable Grant'}</span>
                      </div>
                      <span class="status-badge ${statusClass}">${badgeText}</span>
                    </div>
                    <div class="loan-card-body">
                      <div class="loan-progress">
                        <div class="loan-progress-bar">
                          <div class="loan-progress-fill" style="width: ${progress}%; background: ${isLoan ? 'linear-gradient(90deg, #38a169, #68d391)' : '#4299e1'};"></div>
                        </div>
                        <div class="loan-progress-labels">
                          <span>${isLoan ? `Paid: ${fmtMoney(item.amount - item.balance)}` : 'Full Amount Granted'}</span>
                          <span>${isLoan ? Math.round(progress) + '% Complete' : 'Active'}</span>
                        </div>
                      </div>
                      <div class="loan-details">
                        <div class="loan-detail">
                          <div class="loan-detail-label">Total Amount</div>
                          <div class="loan-detail-value">${fmtMoney(item.amount)}</div>
                        </div>
                        <div class="loan-detail">
                          <div class="loan-detail-label">Outstanding</div>
                          <div class="loan-detail-value">${isLoan ? fmtMoney(item.balance) : '$0.00'}</div>
                        </div>
                        <div class="loan-detail">
                          <div class="loan-detail-label">${isLoan ? 'Monthly Payment' : 'Category'}</div>
                          <div class="loan-detail-value">${isLoan ? fmtMoney(item.monthly_payment || item.balance * 0.1) : (item.category || 'General')}</div>
                        </div>
                        <div class="loan-detail">
                          <div class="loan-detail-label">${isLoan ? 'Due Date' : 'Date Issued'}</div>
                          <div class="loan-detail-value">${isLoan ? (fmtDate(item.due_date) || "25th Monthly") : fmtDate(item.created_at)}</div>
                        </div>
                      </div>
                      ${isLoan && item.status === "active"
                    ? `
                        <div class="loan-actions">
                          <button class="btn btn-secondary" onclick="viewLoanDetails('${item.id}')">View Details</button>
                          <button class="btn btn-primary" onclick="openPaymentModal('${item.id}')">Make Payment</button>
                        </div>
                      `
                    : isLoan ? '' : `<div class="loan-actions"><span style="font-size:0.8rem; color:#64748b; padding:8px; width:100%; text-align:center; background:#f8fafc; border-radius:8px;">Non-Repayable Grant</span></div>`
                  }
                    </div>
                  </div>
                `;
              })
              .join("");
          }
        }

        // Update stats
        const activeLoans = loansData.filter((l) => l.status === "active");
        document.getElementById("activeLoansCount").textContent = activeLoans.length;

        const totalOutstanding = activeLoans.reduce((sum, l) => sum + Number(l.balance || 0), 0);
        document.getElementById("totalOutstanding").textContent = fmtMoney(totalOutstanding);

        const totalPaid = loansData.reduce((sum, l) => sum + (Number(l.amount || 0) - Number(l.balance || 0)), 0);
        document.getElementById("totalPaid").textContent = fmtMoney(totalPaid);
      } catch (error) {
        console.error("Error loading financials:", error);
      }
    }

    // Download payslip
    function downloadPayslip(id) {
      alert(
        `Payslip download for ID: ${id} - This will be implemented with backend integration`
      );
    }

    let currentLoanIdForDetails = null;

    async function viewLoanDetails(id) {
      currentLoanIdForDetails = id;
      document.getElementById("loanDetailsModal").classList.add("show");
      const content = document.getElementById("loanDetailsContent");
      content.innerHTML = '<div style="text-align:center; padding:20px;">Loading details...</div>';

      try {
        const res = await API.request(`/finance/loans/${id}`, { auth: true });
        if (res.success && res.data) {
          renderLoanDetails(res.data);
        }
      } catch (e) {
        function renderLoanDetails(loan) {
          const content = document.getElementById("loanDetailsContent");

          let paymentsRows = '';
          if (loan.payments && loan.payments.length > 0) {
            paymentsRows = loan.payments.map(p => `
                <tr>
                    <td>${fmtDate(p.created_at)}</td>
                    <td>${p.payment_reference || '-'}</td>
                    <td>${p.payment_method}</td>
                    <td><span class="status-badge ${p.status === 'confirmed' ? 'success' : 'pending'}">${p.status}</span></td>
                    <td style="text-align:right;">${fmtMoney(p.amount, loan.currency)}</td>
                </tr>
            `).join('');
          } else {
            paymentsRows = '<tr><td colspan="5" style="text-align:center; padding:20px;">No payments recorded</td></tr>';
          }

          let invoicesRows = '';
          if (loan.invoices && loan.invoices.length > 0) {
            invoicesRows = loan.invoices.map(inv => {
              // Escape for onclick
              const invStr = JSON.stringify(inv).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
              const loanStr = JSON.stringify(loan).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
              return `
                <tr>
                    <td>${inv.invoice_number}</td>
                    <td>${fmtDate(inv.generated_at)}</td>
                    <td>${fmtDate(inv.due_date)}</td>
                    <td><span class="status-badge ${inv.status === 'paid' ? 'success' : 'pending'}">${inv.status}</span></td>
                    <td style="text-align:right;">
                        ${fmtMoney(inv.amount, loan.currency)}
                        <button class="btn btn-sm btn-secondary" style="margin-left:8px; padding:4px 8px; font-size:0.75rem;" onclick='viewHistoricInvoice(${invStr}, ${loanStr})'>View</button>
                    </td>
                </tr>
             `
            }).join('');
          } else {
            invoicesRows = '<tr><td colspan="5" style="text-align:center; padding:20px;">No invoices generated</td></tr>';
          }

          content.innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">
               <div class="panel-card" style="margin:0;">
                  <div class="panel-card-header"><h4>Details</h4></div>
                  <div class="panel-card-body">
                      <div><strong>Reference:</strong> ${loan.id}</div>
                      <div><strong>Purpose:</strong> ${loan.reason || 'Staff Loan'}</div>
                      <div><strong>Date Issued:</strong> ${fmtDate(loan.created_at)}</div>
                      <div><strong>Status:</strong> <span class="status-badge ${loan.status === 'active' ? 'active' : 'pending'}">${loan.status}</span></div>
                  </div>
               </div>
               <div class="panel-card" style="margin:0;">
                   <div class="panel-card-header"><h4>Balance</h4></div>
                   <div class="panel-card-body">
                      <div style="font-size:1.5rem; font-weight:700; color:#1a365d;">${fmtMoney(loan.balance, loan.currency)}</div>
                      <div style="color:#64748b; font-size:0.9rem;">Original Amount: ${fmtMoney(loan.amount, loan.currency)}</div>
                   </div>
               </div>
            </div>

            <div class="invoice-section">
                <div class="invoice-section-title">Payment History</div>
                <table class="data-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Reference</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th style="text-align:right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>${paymentsRows}</tbody>
                </table>
            </div>

            <div class="invoice-section" style="margin-top:24px;">
                <div class="invoice-section-title">Invoices</div>
                <table class="data-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Generated</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th style="text-align:right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>${invoicesRows}</tbody>
                </table>
            </div>
        `;
        }

        function viewHistoricInvoice(invoice, loan) {
          const displayData = {
            invoiceNumber: invoice.invoice_number,
            loan: {
              id: loan.id,
              reason: loan.reason,
              paymentAmount: invoice.amount
            },
            generatedAt: invoice.generated_at,
            dueDate: invoice.due_date,
            amounts: {
              principal: invoice.principal_amount,
              tax: invoice.tax_amount,
              fee: invoice.fee_amount,
              total: invoice.amount
            },
            qrContent: invoice.qr_code_data,
            paymentPin: invoice.payment_pin,
            serviceCode: "UHI-2134",
            accountCode: `G/L/${new Date(invoice.generated_at).getFullYear()}/${loan.id.split('-').pop()}`,
            bankDetails: {
              accountName: 'Global Organization Staff Fund',
              bankName: 'First National Bank',
              accountNumber: '1234567890',
              routingNumber: '021000089',
              swiftCode: 'FNBKUS33XXX',
            }
          };
          // Close loan modal first or stack? Stacking might be messy with z-index.
          // Let's close loan modal
          // closeLoanDetailsModal();
          // But then user loses context. Let's just open invoice modal on top.
          // Ensure invoice modal z-index is higher (it's 1000, loanDetailsModal is same).
          // Let's bump invoice modal z-index via JS or style.
          document.getElementById("invoiceModal").style.zIndex = "1050";
          displayInvoice(displayData);
        }

        function closeLoanDetailsModal() {
          document.getElementById("loanDetailsModal").classList.remove("show");
        }

        async function downloadLoanHistory() {
          if (!currentLoanIdForDetails) return;
          const btn = document.getElementById("btnDownloadHistory");
          const originalText = btn.textContent;
          btn.disabled = true;
          btn.textContent = "Downloading...";

          try {
            await API.download(`finance/loans/${currentLoanIdForDetails}/history/pdf`, `Loan_History_${currentLoanIdForDetails}.pdf`);
          } catch (e) {
            console.error(e);
            alert("Failed to download history.");
          } finally {
            btn.disabled = false;
            btn.textContent = originalText;
          }
        }

        // Download payroll report
        function downloadPayrollReport() {
          alert(
            "Payroll report download will be implemented with backend integration"
          );
        }

        // Initialize
        async function init() {
          if (!window.Auth) return;
          const user = await Auth.checkAuth();
          if (!user) return;

          // Set header info
          const fullName =
            [user.firstName, user.lastName].filter(Boolean).join(" ") || "User";
          document.getElementById("headerName").textContent = fullName;
          document.getElementById("headerAvatar").textContent = (
            user.firstName?.charAt(0) || "U"
          ).toUpperCase();

          await loadPayroll();
          await loadFinancials();
        }

        // Close dropdowns when clicking outside
        document.addEventListener("click", (event) => {
          if (!event.target.closest(".user-menu")) {
            document.getElementById("userDropdown")?.classList.remove("show");
          }
        });

        // Close modals when clicking outside
        document.querySelectorAll(".modal-overlay").forEach((modal) => {
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.classList.remove("show");
            }
          });
        });

        document.addEventListener("DOMContentLoaded", init);
  </script>
</body>

</html>